{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "A bar chart showing the number of DNFs (Did Not Finish) per driver in the 2023 F1 season with a race number slider and constructor highlighting",
  "data": {
    "url": "data/results.csv",
    "format": {"type": "csv"}
  },
  "transform": [
    {
      "lookup": "raceId",
      "from": {
        "data": {
          "url": "data/races.csv",
          "format": {"type": "csv"}
        },
        "key": "raceId",
        "fields": ["year", "round"]
      }
    },
    {
      "filter": "datum.year == 2023"
    },
    {
      "lookup": "driverId",
      "from": {
        "data": {
          "url": "data/drivers.csv",
          "format": {"type": "csv"}
        },
        "key": "driverId",
        "fields": ["surname"]
      }
    },
    {
      "lookup": "constructorId",
      "from": {
        "data": {
          "url": "data/constructors.csv",
          "format": {"type": "csv"}
        },
        "key": "constructorId",
        "fields": ["name"]
      }
    },
    {
      "filter": "datum.statusId != 1"
    },
    {
      "filter": "datum.round <= race_slider"
    },
    {
      "aggregate": [
        {
          "op": "count",
          "as": "DNF_count"
        }
      ],
      "groupby": ["surname", "name"]  
    },
    {
      "calculate": "datum.name == 'Mercedes' || datum.name == 'Ferrari' || datum.name == 'Red Bull' || datum.name == 'Aston Martin' || datum.name == 'McLaren' ? datum.name : 'Other'",
      "as": "team"
    }
  ],
  "params": [
    {
      "name": "race_slider",
      "value": 22,
      "bind": {
        "input": "range",
        "min": 1,
        "max": 22,
        "step": 1,
        "name": "Race Number: "
      }
    }
  ],
  "selection": {
    "constructor_highlight": {
      "type": "multi",
      "fields": ["team"],
      "bind": "legend"
    }
  },
  "mark": "bar",
  "encoding": {
    "x": {
      "field": "surname",
      "type": "nominal",
      "title": "Driver",
      "sort": "-y"
    },
    "y": {
      "field": "DNF_count",
      "type": "quantitative",
      "title": "Number of DNFs"
    },
    "color": {
      "field": "team",
      "scale": {
        "domain": ["Mercedes", "Ferrari", "Red Bull", "Aston Martin", "McLaren", "Other"],
        "range": ["#00D2BE", "#DC0000", "#1E41FF", "#A020F0", "#FF8700", "lightgrey"]
      },
      "legend": {
        "title": "Constructor",
        "orient": "bottom"
      }
    },
    "opacity": {
      "condition": {"selection": "constructor_highlight", "value": 1},
      "value": 0.2
    },
    "tooltip": [
      {"field": "surname", "type": "nominal", "title": "Driver"},
      {"field": "DNF_count", "type": "quantitative", "title": "Number of DNFs"},
      {"field": "name", "type": "nominal", "title": "Constructor"}
    ]
  }
}